<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Sensor Akar Non‑Invasif</title>
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ["Inter","ui-sans-serif","system-ui","Segoe UI","Roboto","Helvetica Neue","Arial"] },
          colors: {
            brand: { 50:'#ecfdf5', 100:'#d1fae5', 500:'#10b981', 600:'#059669' }
          },
          boxShadow: { soft: '0 10px 30px rgba(2,6,23,0.06)' }
        }
      }
    }
  </script>
  <!-- Leaflet (Map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    html, body { height:100%; }
    .leaflet-container { font: 12px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif; }
  </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-800">
  <!-- Header -->
 <header class="sticky top-0 z-30 backdrop-blur bg-white/70 border-b border-slate-200">
<div class="max-w-7xl mx-auto px-4 py-3">
<div class="flex items-center justify-between">
<div class="flex items-start gap-3 min-w-0">
<span class="inline-flex items-center justify-center w-10 h-10 rounded-2xl bg-brand-50 text-brand-600 flex-shrink-0">
<svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 2l5 7h-3l4 6h-4l3 5H7l3-5H6l4-6H7l5-7Z"/></svg>
</span>
<div class="min-w-0">
<h1 class="text-lg sm:text-xl font-semibold truncate">Dashboard Sensor Akar Non‑Invasif</h1>
<p class="text-xs sm:text-sm text-slate-500 truncate">Pemantauan akar & kemiringan batang • Smart Green City</p>
</div>
</div>
<!-- Mobile Hamburger -->
<button id="menu-toggle" class="sm:hidden p-2 rounded-lg border border-slate-200">
<svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/></svg>
</button>
<!-- Desktop Buttons -->
<div id="menu" class="hidden sm:flex flex-wrap gap-2">
<button id="toggle-sim" class="px-3 py-2 rounded-xl border text-sm bg-emerald-50 border-emerald-200 text-emerald-700">Simulasi Aktif</button>
<button id="open-report" class="px-3 py-2 rounded-xl border text-sm bg-white border-slate-200">+ Laporan</button>
<button onclick="location.reload()" class="px-3 py-2 rounded-xl border text-sm bg-white border-slate-200">Muat Ulang</button>
</div>
</div>
<!-- Mobile Menu -->
<div id="mobile-menu" class="sm:hidden hidden mt-3 flex flex-col gap-2">
<button id="toggle-sim-m" class="px-3 py-2 rounded-xl border text-sm bg-emerald-50 border-emerald-200 text-emerald-700">Simulasi Aktif</button>
<button id="open-report-m" class="px-3 py-2 rounded-xl border text-sm bg-white border-slate-200">+ Laporan</button>
<button onclick="location.reload()" class="px-3 py-2 rounded-xl border text-sm bg-white border-slate-200">Muat Ulang</button>
</div>
</div>
<script>
document.getElementById('menu-toggle').addEventListener('click',()=>{
const m=document.getElementById('mobile-menu');
m.classList.toggle('hidden');
});
</script>
</header>

  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
    <!-- KPI Cards -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4" id="kpi-cards"></section>

    <!-- Filters -->
    <section class="flex flex-col lg:flex-row gap-3 items-stretch lg:items-center">
      <div class="flex-1 flex items-center gap-2 bg-white border border-slate-200 rounded-xl px-3 py-2">
        <svg class="w-4 h-4 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="11" cy="11" r="7"/><path d="M21 21l-4.3-4.3"/></svg>
        <input id="search" class="w-full outline-none text-sm" placeholder="Cari sensor: TREE-003 / Mahoni" />
      </div>
      <div class="flex items-center gap-2">
        <span class="text-xs text-slate-500">Status</span>
        <select id="status-filter" class="bg-white border border-slate-200 rounded-xl px-3 py-2 text-sm">
          <option>Semua</option>
          <option>Sehat</option>
          <option>Hampir Tumbang</option>
          <option>Tumbang</option>
        </select>
      </div>
      <div class="flex items-center gap-2">
        <span class="text-xs text-slate-500">Spesies</span>
        <select id="species-filter" class="bg-white border border-slate-200 rounded-xl px-3 py-2 text-sm">
          <option>Semua</option>
        </select>
      </div>
      <button id="export" class="ml-auto px-3 py-2 rounded-xl border bg-white border-slate-200 text-sm">Ekspor CSV</button>
    </section>

    <!-- Charts -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <div class="bg-white border border-slate-200 rounded-2xl p-4 shadow-soft lg:col-span-2">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold">Tren Kesehatan & Kemiringan (24 jam)</h3>
          <span class="text-xs text-slate-500">Data dummy & simulasi</span>
        </div>
        <div class="h-64"><canvas id="trendChart"></canvas></div>
      </div>
      <div class="bg-white border border-slate-200 rounded-2xl p-4 shadow-soft">
        <h3 class="font-semibold mb-3">Distribusi Status Saat Ini</h3>
        <div class="h-64"><canvas id="distChart"></canvas></div>
      </div>
    </section>

    <!-- Map + Reports -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <div class="bg-white border border-slate-200 rounded-2xl shadow-soft lg:col-span-2 overflow-hidden">
        <div class="p-4 flex items-center justify-between">
          <h3 class="font-semibold">Peta Titik Sensor</h3>
          <div class="flex gap-3 text-xs items-center">
            <span class="inline-flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-emerald-500"></span> Sehat</span>
            <span class="inline-flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-amber-500"></span> Hampir Tumbang</span>
            <span class="inline-flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-rose-500"></span> Tumbang</span>
          </div>
        </div>
        <div class="h-[420px]" id="map"></div>
      </div>
      <div class="bg-white border border-slate-200 rounded-2xl p-4 shadow-soft">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">Laporan Masyarakat</h3>
          <div class="text-xs text-slate-500">Real‑time (simulasi)</div>
        </div>
        <div id="reports" class="space-y-3 max-h-[420px] overflow-auto pr-1"></div>
      </div>
    </section>

    <!-- Table -->
    <section class="bg-white border border-slate-200 rounded-2xl p-4 shadow-soft">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold">Daftar Sensor</h3>
        <div class="text-xs text-slate-500">Klik marker di peta untuk detail cepat • Klik header tabel untuk sort</div>
      </div>
      <div class="overflow-auto">
        <table class="w-full text-sm" id="sensor-table">
          <thead class="bg-slate-50">
            <tr class="text-left select-none">
              <th data-sort="id" class="p-2 cursor-pointer">ID ▲▼</th>
              <th data-sort="species" class="p-2 cursor-pointer">Spesies ▲▼</th>
              <th data-sort="status" class="p-2 cursor-pointer">Status ▲▼</th>
              <th data-sort="tiltDeg" class="p-2 cursor-pointer">Kemiringan (°) ▲▼</th>
              <th data-sort="healthScore" class="p-2 cursor-pointer">Kesehatan ▲▼</th>
              <th data-sort="battery" class="p-2 cursor-pointer">Baterai ▲▼</th>
              <th data-sort="lastSeen" class="p-2 cursor-pointer">Terakhir ▲▼</th>
            </tr>
          </thead>
          <tbody id="sensor-tbody"></tbody>
        </table>
      </div>
    </section>

    <footer class="py-6 text-center text-xs text-slate-500">
      © <span id="year"></span> Inovasi Sensor Akar Non‑Invasif • Demo Dashboard (dummy).
    </footer>
  </main>

  <!-- Modal Tambah Laporan -->
  <div id="modal" class="fixed inset-0 z-40 hidden">
    <div class="absolute inset-0 bg-black/30" onclick="closeModal()"></div>
    <div class="relative mx-auto mt-24 w-[92%] max-w-md bg-white rounded-2xl shadow-soft p-4">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-semibold">Kirim Laporan Masyarakat</h3>
        <button onclick="closeModal()" class="text-slate-500">✕</button>
      </div>
      <div class="space-y-3">
        <div>
          <label class="text-xs text-slate-500">Nama</label>
          <input id="rp-name" class="w-full mt-1 px-3 py-2 border border-slate-200 rounded-xl" placeholder="Nama Anda" />
        </div>
        <div>
          <label class="text-xs text-slate-500">Pilih Sensor</label>
          <select id="rp-sensor" class="w-full mt-1 px-3 py-2 border border-slate-200 rounded-xl"></select>
        </div>
        <div>
          <label class="text-xs text-slate-500">Pesan</label>
          <textarea id="rp-msg" rows="3" class="w-full mt-1 px-3 py-2 border border-slate-200 rounded-xl" placeholder="Tulis laporan singkat..."></textarea>
        </div>
        <div class="flex justify-end gap-2 pt-2">
          <button onclick="closeModal()" class="px-3 py-2 rounded-xl border bg-white border-slate-200 text-sm">Batal</button>
          <button id="rp-submit" class="px-3 py-2 rounded-xl bg-brand-500 text-white text-sm">Kirim</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-5 left-1/2 -translate-x-1/2 z-50 hidden">
    <div class="bg-slate-900 text-white text-sm px-4 py-2 rounded-xl shadow-soft">Tersimpan</div>
  </div>

  <script>
    // ===== Utilities =====
    const rand = (min, max) => Math.random() * (max - min) + min;
    const STATUS = { HEALTHY: 'Sehat', WARNING: 'Hampir Tumbang', FALLEN: 'Tumbang' };
    const statusColor = (s) => s === STATUS.HEALTHY ? '#10b981' : s === STATUS.WARNING ? '#f59e0b' : '#ef4444';
    const fmtTime = (ts) => new Date(ts).toLocaleString('id-ID', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: 'short' });
    const avg = (arr)=> arr.reduce((a,b)=>a+b,0)/arr.length;
    const round1 = (n)=> Math.round(n*10)/10;
    function classify({ tiltDeg, healthScore }) {
      if (tiltDeg >= 25 || healthScore < 35) return STATUS.FALLEN;
      if (tiltDeg >= 12 || healthScore < 60) return STATUS.WARNING;
      return STATUS.HEALTHY;
    }
    function badgeBg(status){ return status===STATUS.HEALTHY?'#ecfdf5': status===STATUS.WARNING?'#fffbeb':'#fef2f2'; }
    function badgeText(status){ return status===STATUS.HEALTHY?'#065f46': status===STATUS.WARNING?'#92400e':'#991b1b'; }

    // ===== Dummy Sensors =====
    const SPECIES = ['Mahoni','Angsana','Trembesi','Beringin','Ketapang','Tabebuya','Jati','Kihujan'];
    let sensors = Array.from({ length: 36 }).map((_, i) => {
      const tilt = Math.abs(rand(0, 18) + (Math.random() < 0.12 ? rand(7, 15) : 0));
      const health = Math.max(10, Math.min(100, 100 - tilt * 2 + rand(-10, 8)));
      return {
        id: `TREE-${String(i+1).padStart(3,'0')}`,
        species: SPECIES[Math.floor(Math.random()*SPECIES.length)],
        lat: -6.2 + rand(-0.09, 0.09),
        lng: 106.82 + rand(-0.13, 0.13),
        tiltDeg: Number(tilt.toFixed(1)),
        healthScore: Math.round(health),
        battery: Math.round(Math.max(5, Math.min(100, rand(25, 100)))) ,
        rssi: Math.round(rand(-95, -55)),
        lastSeen: Date.now() - Math.round(rand(0, 1000*60*60*12)),
      };
    });
    sensors = sensors.map(s => ({...s, status: classify(s)}));

    // ===== Dummy Reports =====
    let reports = Array.from({ length: 10 }).map((_, i) => ({
      id: `RPT-${i+1}`,
      name: ['Ayu','Rizky','Tono','Sari','Bima','Dewi','Andi','Lina'][Math.floor(Math.random()*8)],
      message: ['Dahan patah dekat halte.','Pohon miring setelah hujan deras.','Akar muncul di permukaan trotoar.','Daun menguning beberapa hari ini.','Kabel listrik tersangkut di cabang.','Perlu pemangkasan ringan.'][Math.floor(Math.random()*6)],
      sensorId: sensors[Math.floor(rand(0, sensors.length))].id,
      createdAt: Date.now() - rand(0, 1000*60*60*24*5),
      status: ['Baru','Diproses','Selesai'][Math.floor(Math.random()*3)]
    }));

    // ===== Elements =====
    const els = {
      kpi: document.getElementById('kpi-cards'),
      search: document.getElementById('search'),
      filter: document.getElementById('status-filter'),
      species: document.getElementById('species-filter'),
      tbody: document.getElementById('sensor-tbody'),
      exportBtn: document.getElementById('export'),
      reports: document.getElementById('reports'),
      toggleSim: document.getElementById('toggle-sim'),
      openReport: document.getElementById('open-report'),
      year: document.getElementById('year'),
    };
    els.year.textContent = new Date().getFullYear();

    // populate species filter
    const distinctSpecies = Array.from(new Set(sensors.map(s=>s.species))).sort();
    distinctSpecies.forEach(sp=>{
      const opt = document.createElement('option'); opt.textContent = sp; els.species.appendChild(opt);
    });

    // ===== Map =====
    const map = L.map('map').setView([-6.2, 106.82], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap kontributor' }).addTo(map);
    const markerLayer = L.layerGroup().addTo(map);
    function renderMarkers(list) {
      markerLayer.clearLayers();
      list.forEach(s => {
        const marker = L.circleMarker([s.lat, s.lng], { radius: 8, color: statusColor(s.status), fillOpacity: 0.9 });
        marker.bindPopup(`
          <div style="font-weight:600">${s.id} • ${s.species}</div>
          <div>Status: <b style="color:${statusColor(s.status)}">${s.status}</b></div>
          <div>Kemiringan: <b>${s.tiltDeg}°</b></div>
          <div>Kesehatan Akar: <b>${s.healthScore}/100</b></div>
          <div>Baterai: <b>${s.battery}%</b> • Sinyal: <b>${s.rssi} dBm</b></div>
          <div style="font-size:11px;color:#64748b">Terakhir: ${fmtTime(s.lastSeen)}</div>
        `);
        marker.on('click', ()=> highlightRow(s.id));
        markerLayer.addLayer(marker);
      });
    }

    // ===== Charts =====
    const trendCtx = document.getElementById('trendChart');
    const distCtx = document.getElementById('distChart');
    const hourlyLabels = Array.from({length:25}).map((_,i)=>{
      const d = new Date(Date.now() - (24-i)*3600*1000);
      return d.toLocaleTimeString('id-ID',{hour:'2-digit'});
    });
    const hist = { health: Array(25).fill(avg(sensors.map(s=>s.healthScore))).map(n=>Math.round(n+rand(-8,8))), tilt: Array(25).fill(avg(sensors.map(s=>s.tiltDeg))).map(n=>round1(n+rand(-2,2))) };
    const trendChart = new Chart(trendCtx, {
      type: 'line',
      data: {
        labels: hourlyLabels,
        datasets: [
          { label: 'Skor Kesehatan Rata2', data: hist.health, yAxisID: 'y1', tension: 0.35 },
          { label: 'Kemiringan Rata2 (°)', data: hist.tilt, yAxisID: 'y2', tension: 0.35 },
        ]
      },
      options: {
        maintainAspectRatio: false,
        scales: {
          y1: { type:'linear', position:'left', min:0, max:100 },
          y2: { type:'linear', position:'right', min:0, max:30, grid: { drawOnChartArea:false } },
        },
        plugins: { legend: { display:true } }
      }
    });
    const distChart = new Chart(distCtx, {
      type: 'bar',
      data: { labels: ['Sehat','Hampir Tumbang','Tumbang'], datasets: [{ label:'Jumlah', data: [0,0,0] }] },
      options: { maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } }
    });

    // ===== Rendering =====
    function renderAll() {
      const list = applyFilter();
      renderKpis();
      renderTable(list);
      renderMarkers(list);
      renderReports();
      updateDistChart();
    }

    function renderKpis() {
      const healthy = sensors.filter(s=>s.status===STATUS.HEALTHY).length;
      const warning = sensors.filter(s=>s.status===STATUS.WARNING).length;
      const fallen = sensors.filter(s=>s.status===STATUS.FALLEN).length;
      const lowBatt = sensors.filter(s=>s.battery < 20).length;
      const kpi = [
        {title:'Pohon Sehat', val:healthy, hint:'Status normal', cls:'bg-emerald-50 border-emerald-200 text-emerald-700', icon:`<svg class=\"w-5 h-5\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.5\"><path d=\"M12 2l5 7H7l5-7Z\"/><path d=\"M7 9l5 8 5-8\"/></svg>`},
        {title:'Hampir Tumbang', val:warning, hint:'Perlu inspeksi', cls:'bg-amber-50 border-amber-200 text-amber-700', icon:`<svg class=\"w-5 h-5\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.5\"><path d=\"M12 9v4\"/><path d=\"M12 17h.01\"/><circle cx=\"12\" cy=\"12\" r=\"9\"/></svg>`},
        {title:'Tumbang', val:fallen, hint:'Tindak segera', cls:'bg-rose-50 border-rose-200 text-rose-700', icon:`<svg class=\"w-5 h-5\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.5\"><path d=\"M18 6L6 18\"/><path d=\"M6 6l12 12\"/></svg>`},
        {title:'Baterai < 20%', val:lowBatt, hint:'Butuh penggantian', cls:'bg-sky-50 border-sky-200 text-sky-700', icon:`<svg class=\"w-5 h-5\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.5\"><rect x=\"2\" y=\"7\" width=\"16\" height=\"10\" rx=\"2\"/><path d=\"M22 11v4\"/></svg>`},
      ];
      els.kpi.innerHTML = kpi.map(k=>`
        <div class="bg-white border border-slate-200 rounded-2xl p-4 shadow-soft hover:shadow transition-shadow">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm text-slate-500">${k.title}</div>
              <div class="text-3xl font-semibold mt-1">${k.val}</div>
              <div class="text-xs text-slate-500 mt-1">${k.hint}</div>
            </div>
            <div class="px-3 py-2 rounded-xl border ${k.cls} text-sm inline-flex items-center gap-2">${k.icon}<span>${k.title.split(' ')[0]}</span></div>
          </div>
        </div>
      `).join('');
    }

    function renderTable(list) {
      els.tbody.innerHTML = list.map(s=>`
        <tr class="border-t hover:bg-slate-50">
          <td class="p-2 font-mono">${s.id}</td>
          <td class="p-2">${s.species}</td>
          <td class="p-2"><span class="px-2 py-1 rounded-full text-xs" style="background:${badgeBg(s.status)};color:${badgeText(s.status)}">${s.status}</span></td>
          <td class="p-2">${s.tiltDeg}</td>
          <td class="p-2">${s.healthScore}</td>
          <td class="p-2">${s.battery}%</td>
          <td class="p-2 text-slate-500">${fmtTime(s.lastSeen)}</td>
        </tr>
      `).join('');
    }

    function renderReports() {
      els.reports.innerHTML = reports.map(r=>`
        <div class="border border-slate-200 rounded-xl p-3">
          <div class="flex items-center justify-between">
            <div class="text-sm font-medium">${r.name}</div>
            <div class="text-[10px] px-2 py-1 rounded-full ${r.status==='Baru'?'bg-rose-50 text-rose-700 border border-rose-200': r.status==='Diproses'?'bg-amber-50 text-amber-700 border border-amber-200':'bg-emerald-50 text-emerald-700 border border-emerald-200'}">${r.status}</div>
          </div>
          <div class="text-xs text-slate-500">${fmtTime(r.createdAt)} • Sensor ${r.sensorId}</div>
          <p class="text-sm mt-1">${r.message}</p>
        </div>
      `).join('');
    }

    function updateDistChart() {
      const healthy = sensors.filter(s=>s.status===STATUS.HEALTHY).length;
      const warning = sensors.filter(s=>s.status===STATUS.WARNING).length;
      const fallen = sensors.filter(s=>s.status===STATUS.FALLEN).length;
      distChart.data.datasets[0].data = [healthy, warning, fallen];
      distChart.update();
    }

    function updateTrendChart() {
      const avgHealth = avg(sensors.map(s=>s.healthScore));
      const avgTilt = avg(sensors.map(s=>s.tiltDeg));
      shiftAndPush(trendChart.data.datasets[0].data, Math.round(avgHealth));
      shiftAndPush(trendChart.data.datasets[1].data, round1(avgTilt));
      trendChart.update();
    }

    // ===== Filters & Sort =====
    function applyFilter() {
      const q = (els.search.value || '').toLowerCase();
      const f = els.filter.value; const sp = els.species.value;
      return sensors.filter(s => {
        const txt = `${s.id} ${s.species}`.toLowerCase();
        const okTxt = txt.includes(q);
        const okStatus = f === 'Semua' || s.status === f;
        const okSpecies = sp === 'Semua' || s.species === sp;
        return okTxt && okStatus && okSpecies;
      }).sort(sorter.fn);
    }
    els.search.addEventListener('input', renderAll);
    els.filter.addEventListener('change', renderAll);
    els.species.addEventListener('change', renderAll);

    // table sorting
    const sorter = { key:'id', asc:true, fn:(a,b)=> a.id.localeCompare(b.id) };
    document.querySelectorAll('#sensor-table thead th').forEach(th=>{
      th.addEventListener('click', ()=>{
        const key = th.dataset.sort; sorter.asc = sorter.key===key ? !sorter.asc : true; sorter.key = key;
        sorter.fn = (a,b)=>{
          const A=a[key], B=b[key];
          if (typeof A === 'number' && typeof B === 'number') return sorter.asc ? A-B : B-A;
          if (key==='lastSeen') return sorter.asc ? A-B : B-A;
          return sorter.asc ? String(A).localeCompare(String(B)) : String(B).localeCompare(String(A));
        };
        renderAll();
      });
    });

    // ===== Export CSV =====
    els.exportBtn.addEventListener('click', ()=>{
      const header = ['id','species','status','tiltDeg','healthScore','battery','rssi','lat','lng','lastSeen'];
      const rows = sensors.map(s => [s.id,s.species,s.status,s.tiltDeg,s.healthScore,s.battery,s.rssi,s.lat,s.lng,new Date(s.lastSeen).toISOString()]);
      const csv = [header.join(','), ...rows.map(r=>r.join(','))].join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = Object.assign(document.createElement('a'), { href:url, download:`sensor-data-${Date.now()}.csv` });
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      toast('Data diekspor.');
    });

    // ===== Simulation =====
    let simOn = true; let timer = null;
    function startSim(){ if(timer) return; timer = setInterval(tick, 5000); }
    function stopSim(){ clearInterval(timer); timer=null; }
    els.toggleSim.addEventListener('click', ()=>{ simOn=!simOn; els.toggleSim.textContent = simOn? 'Simulasi Aktif':'Simulasi Mati'; if(simOn) startSim(); else stopSim(); });

    function tick() {
      sensors = sensors.map(s=>{
        const tilt = Math.max(0, s.tiltDeg + rand(-0.6, 0.8));
        const health = Math.max(5, Math.min(100, s.healthScore + rand(-2.5, 1.5)));
        const battery = Math.max(3, Math.min(100, s.battery + rand(-0.4, 0)));
        const status = classify({ tiltDeg: tilt, healthScore: health });
        return { ...s, tiltDeg: round1(tilt), healthScore: Math.round(health), battery: Math.round(battery), status, lastSeen: Date.now() };
      });
      if (Math.random() < 0.25 && sensors.length) {
        const tId = sensors[Math.floor(rand(0, sensors.length))].id;
        reports = [ { id:`RPT-${Math.floor(rand(1000,9999))}`, name:['Warga','Penjual','Satpam','Mahasiswa'][Math.floor(Math.random()*4)], message:['Terlihat miring pasca hujan.','Ranting jatuh ke jalan.','Perlu pemangkasan ringan.','Akar mengangkat paving.'][Math.floor(Math.random()*4)], sensorId:tId, createdAt:Date.now(), status:'Baru' }, ...reports ].slice(0,20);
      }
      updateTrendChart();
      renderAll();
    }

    // ===== Report Modal =====
    const modal = document.getElementById('modal');
    const rpName = document.getElementById('rp-name');
    const rpSensor = document.getElementById('rp-sensor');
    const rpMsg = document.getElementById('rp-msg');
    const rpSubmit = document.getElementById('rp-submit');
    function openModal(){ modal.classList.remove('hidden'); rpName.focus(); }
    function closeModal(){ modal.classList.add('hidden'); }
    function toast(msg){ const t=document.getElementById('toast'); t.querySelector('div').textContent=msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 1600); }
    els.openReport.addEventListener('click', ()=>{ rpSensor.innerHTML = sensors.map(s=>`<option value="${s.id}">${s.id} • ${s.species}</option>`).join(''); openModal(); });
    rpSubmit.addEventListener('click', ()=>{
      const name = rpName.value.trim()||'Warga';
      const sensorId = rpSensor.value; const message = rpMsg.value.trim()||'Laporan kondisi pohon.';
      reports = [{ id:`RPT-${Date.now()}`, name, sensorId, message, createdAt:Date.now(), status:'Baru' }, ...reports].slice(0,20);
      closeModal(); renderReports(); toast('Laporan dikirim.'); rpName.value=''; rpMsg.value='';
    });

    // ===== Helpers =====
    function shiftAndPush(arr, val){ arr.shift(); arr.push(val); }
    function highlightRow(id){
      const rows = Array.from(document.querySelectorAll('#sensor-tbody tr'));
      rows.forEach(r=> r.classList.remove('ring','ring-amber-300'));
      const idx = sensors.findIndex(s=>s.id===id);
      if (idx>-1) { const row = rows[idx]; row.scrollIntoView({behavior:'smooth', block:'center'}); row.classList.add('ring','ring-amber-300'); setTimeout(()=>row.classList.remove('ring','ring-amber-300'), 1500); }
    }

    // ===== Init =====
    renderAll();
    // charts initial distribution
    updateDistChart();
    // init modal sensor options
    document.getElementById('rp-sensor').innerHTML = sensors.map(s=>`<option value="${s.id}">${s.id} • ${s.species}</option>`).join('');
    // start simulation
    startSim();
  </script>
</body>
</html>


